<!DOCTYPE html>
<html>
<head>
    <title>Brain Busters Math Admin</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f4f8; display: flex; gap: 20px; }
        .column { flex: 1; }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-left: 5px solid #3498db; padding-left: 15px; margin-bottom: 20px; }
        input, select, textarea { width: 100%; margin: 8px 0; padding: 12px; border: 1px solid #d1d9e6; border-radius: 6px; box-sizing: border-box; }
        button { background: #3498db; color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        button:hover { opacity: 0.9; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
        .top-score { background: rgba(241, 196, 15, 0.15) !important; font-weight: bold; border-left: 4px solid #f1c40f; }
        .tab-btn { flex: 1; padding: 10px; cursor: pointer; background: #e0e0e0; border: none; font-weight: bold; }
        .tab-btn.active { background: #3498db; color: white; }
        .tab-container { display: flex; margin-bottom: 15px; border-radius: 6px; overflow: hidden; }
        .del-btn { background: #e74c3c; color: white; padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 12px; width: auto; }
        #preview-box { margin-top: 10px; text-align: center; display: none; padding: 10px; border: 2px dashed #ccc; border-radius: 6px; background: #fafafa; }
        #preview-img { max-width: 100%; max-height: 150px; border-radius: 4px; display: block; margin: 0 auto; }
        
        /* üÜï Report Modal Styles */
        #report-modal { display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 100; }
        #report-content { background: white; padding: 25px; border-radius: 10px; width: 400px; max-width: 90%; }
        .mistake-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .report-btn { background: #95a5a6; padding: 5px 10px; font-size: 11px; border-radius: 4px; cursor: pointer; margin-left: 5px; color: white; border: none; }
    </style>
</head>
<body>
    <div class="column">
        <h1>üî¢ Curriculum Manager</h1>
        <div class="card">
            <div class="tab-container">
                <button class="tab-btn active" onclick="showTab('add')" id="btn-add">‚ûï Add New</button>
                <button class="tab-btn" onclick="showTab('manage')" id="btn-manage">üìÇ Manage Existing</button>
            </div>
            
            <div id="view-add">
                <h3>Add Kindergarten Quiz</h3>
                
                <button onclick="massPopulate()" style="background: #8e44ad; margin-bottom: 15px;">‚ö° Quick Start: Add Sample Questions</button>
                <hr style="margin-bottom: 15px; border: 0; border-top: 1px solid #eee;">

                <select id="math-topic">
                    <option value="Addition">Addition ‚ûï</option>
                    <option value="Subtraction">Subtraction ‚ûñ</option>
                    <option value="Geometry">Geometry üìê</option>
                </select>
                <select id="quiz-difficulty">
                    <option value="Easy">Easy (0-5) üü¢</option>
                    <option value="Hard">Hard (0-10) üî¥</option>
                </select>
                <input type="text" id="sub-concept" placeholder="Concept Name (e.g., Adding 1s)">
                <input type="text" id="question" placeholder="Question (e.g., Count the apples)">
                <div style="display: flex; gap: 5px; align-items: center;">
                    <input type="text" id="q-image" placeholder="üñºÔ∏è Image URL (Direct .jpg/.png link)" style="margin:0;">
                    <button onclick="testImage()" style="width: auto; padding: 10px; background: #f39c12;">Test Link üñºÔ∏è</button>
                </div>
                <div id="preview-box">
                    <span style="font-size: 12px; color: #777;">Image Preview:</span>
                    <img id="preview-img" src="" onerror="imgError()">
                    <p id="img-msg" style="color: red; font-size: 12px; display: none;">‚ùå Link broken. Try a direct image link.</p>
                </div>
                <input type="text" id="answer" placeholder="Correct Answer (e.g. 5)" style="margin-top: 8px;">
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="w1" placeholder="Wrong 1"><input type="text" id="w2" placeholder="Wrong 2"><input type="text" id="w3" placeholder="Wrong 3">
                </div>
                <textarea id="hint" placeholder="üí° Hint..."></textarea>
                <button onclick="addQuiz()" style="background: #27ae60;">Save to Cloud ‚òÅÔ∏è</button>
            </div>
            <div id="view-manage" style="display:none;">
                <h3>Question Bank</h3>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="filter-topic" onchange="loadQuestions()">
                        <option value="Addition">Addition ‚ûï</option>
                        <option value="Subtraction">Subtraction ‚ûñ</option>
                        <option value="Geometry">Geometry üìê</option>
                    </select>
                    <button onclick="loadQuestions()" style="width: auto; padding: 8px 15px; background: #95a5a6;">Refresh üîÑ</button>
                </div>
                <div id="questions-list" style="max-height: 400px; overflow-y: auto;">
                    <p style="color:#777;">Select a topic and click Refresh.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="column">
        <h1>üìä Mastery Tracker</h1>
        <div class="card">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h3>Student Progress</h3>
                <button onclick="loadScores()" style="width: auto; padding: 8px 15px; background: #95a5a6;">Refresh üîÑ</button>
            </div>
            <select id="sort-by" onchange="loadScores()">
                <option value="timestamp">Most Recent ‚è±Ô∏è</option>
                <option value="score">Highest Score üèÜ</option>
            </select>
            <table>
                <thead><tr><th>Student</th><th>Topic</th><th>Level</th><th>Score</th><th>Details</th></tr></thead>
                <tbody id="score-table"></tbody>
            </table>
        </div>
    </div>

    <div id="report-modal">
        <div id="report-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>üìë Mistake Report</h3>
                <button onclick="document.getElementById('report-modal').style.display='none'" style="width:auto; background:#e74c3c;">Close</button>
            </div>
            <div id="report-body" style="max-height:300px; overflow-y:auto; margin-top:10px;"></div>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { doc, setDoc, deleteDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // Global list for modal access
        let globalScores = [];

        window.showTab = function(mode) {
            document.getElementById('view-add').style.display = mode === 'add' ? 'block' : 'none';
            document.getElementById('view-manage').style.display = mode === 'manage' ? 'block' : 'none';
            document.getElementById('btn-add').className = mode === 'add' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('btn-manage').className = mode === 'manage' ? 'tab-btn active' : 'tab-btn';
            if(mode === 'manage') loadQuestions();
        };

        window.testImage = function() {
            const url = document.getElementById('q-image').value; if(!url) return;
            document.getElementById('preview-box').style.display = 'block';
            const img = document.getElementById('preview-img');
            document.getElementById('img-msg').style.display = 'none'; img.style.display = 'block'; img.src = url;
        };
        window.imgError = function() { document.getElementById('preview-img').style.display = 'none'; document.getElementById('img-msg').style.display = 'block'; };

        window.addQuiz = async function() {
            const q = document.getElementById('question').value; const a = document.getElementById('answer').value;
            if(!q || !a) { alert("Please fill in the Question and Answer!"); return; }
            const topic = document.getElementById('math-topic').value; const sc = document.getElementById('sub-concept').value || "General";
            await setDoc(doc(db, "MathTopics", topic, "Quizzes", sc + "_" + Date.now()), { 
                subConcept: sc, difficulty: document.getElementById('quiz-difficulty').value, question: q, imageUrl: document.getElementById('q-image').value.trim(), 
                answer: a, wrongOptions: [document.getElementById('w1').value.trim(), document.getElementById('w2').value.trim(), document.getElementById('w3').value.trim()], hint: document.getElementById('hint').value
            });
            document.getElementById('question').value = ""; document.getElementById('q-image').value = ""; document.getElementById('answer').value = ""; document.getElementById('w1').value = ""; document.getElementById('w2').value = ""; document.getElementById('w3').value = ""; document.getElementById('hint').value = ""; document.getElementById('preview-box').style.display = 'none';
            alert("Question Saved! ‚ú®");
        };

        // üÜï MASS POPULATE FUNCTION
        window.massPopulate = async function() {
            if(!confirm("This will add 12 sample questions to your database. Continue?")) return;
            
const samples = [
    // ============================
    // ‚ûï ADDITION (Easy: 0-5)
    // ============================
    { topic: "Addition", diff: "Easy", q: "1 + 1 = ?", a: "2", w: ["1", "3", "4"], h: "One plus one.", sc: "Sums" },
    { topic: "Addition", diff: "Easy", q: "2 + 1 = ?", a: "3", w: ["2", "4", "5"], h: "Count one more than two.", sc: "Sums" },
    { topic: "Addition", diff: "Easy", q: "0 + 4 = ?", a: "4", w: ["0", "5", "3"], h: "Adding nothing changes nothing.", sc: "Zero Property" },
    { topic: "Addition", diff: "Easy", q: "3 + 2 = ?", a: "5", w: ["4", "6", "1"], h: "Three fingers and two fingers.", sc: "Sums" },
    { topic: "Addition", diff: "Easy", q: "2 + 2 = ?", a: "4", w: ["2", "3", "5"], h: "Double two.", sc: "Doubles" },
    { topic: "Addition", diff: "Easy", q: "1 + 3 = ?", a: "4", w: ["3", "5", "2"], h: "One step after three.", sc: "Sums" },
    { topic: "Addition", diff: "Easy", q: "5 + 0 = ?", a: "5", w: ["0", "6", "4"], h: "Five plus nothing.", sc: "Zero Property" },
    { topic: "Addition", diff: "Easy", q: "1 + 2 = ?", a: "3", w: ["1", "4", "2"], h: "One, two, three!", sc: "Sums" },
    { topic: "Addition", diff: "Easy", q: "1 + 4 = ?", a: "5", w: ["4", "6", "3"], h: "Count them all up.", sc: "Sums" },
    { topic: "Addition", diff: "Easy", q: "0 + 2 = ?", a: "2", w: ["0", "3", "1"], h: "Just two.", sc: "Zero Property" },

    // ============================
    // ‚ûï ADDITION (Hard: 0-10)
    // ============================
    { topic: "Addition", diff: "Hard", q: "5 + 5 = ?", a: "10", w: ["9", "8", "11"], h: "High ten!", sc: "Doubles" },
    { topic: "Addition", diff: "Hard", q: "3 + 4 = ?", a: "7", w: ["6", "8", "5"], h: "Double three plus one.", sc: "Sums" },
    { topic: "Addition", diff: "Hard", q: "6 + 2 = ?", a: "8", w: ["7", "9", "6"], h: "Six, seven, eight.", sc: "Sums" },
    { topic: "Addition", diff: "Hard", q: "2 + 7 = ?", a: "9", w: ["8", "10", "6"], h: "Almost ten.", sc: "Sums" },
    { topic: "Addition", diff: "Hard", q: "4 + 4 = ?", a: "8", w: ["7", "9", "0"], h: "Spider legs count.", sc: "Doubles" },
    { topic: "Addition", diff: "Hard", q: "1 + 9 = ?", a: "10", w: ["8", "9", "11"], h: "One more to make ten.", sc: "Making Ten" },
    { topic: "Addition", diff: "Hard", q: "3 + 3 = ?", a: "6", w: ["5", "7", "4"], h: "Double three.", sc: "Doubles" },
    { topic: "Addition", diff: "Hard", q: "8 + 1 = ?", a: "9", w: ["8", "7", "10"], h: "Just after eight.", sc: "Sums" },
    { topic: "Addition", diff: "Hard", q: "5 + 2 = ?", a: "7", w: ["6", "8", "9"], h: "Five and two more.", sc: "Sums" },
    { topic: "Addition", diff: "Hard", q: "6 + 3 = ?", a: "9", w: ["8", "7", "10"], h: "Count up three times.", sc: "Sums" },

    // ============================
    // ‚ûñ SUBTRACTION (Easy: 0-5)
    // ============================
    { topic: "Subtraction", diff: "Easy", q: "5 - 1 = ?", a: "4", w: ["3", "5", "2"], h: "Take one away from five.", sc: "Simple Sub" },
    { topic: "Subtraction", diff: "Easy", q: "3 - 2 = ?", a: "1", w: ["2", "3", "0"], h: "Three take away two.", sc: "Difference" },
    { topic: "Subtraction", diff: "Easy", q: "2 - 2 = ?", a: "0", w: ["1", "2", "4"], h: "Take it all away!", sc: "Zero Result" },
    { topic: "Subtraction", diff: "Easy", q: "4 - 1 = ?", a: "3", w: ["2", "4", "5"], h: "One less than four.", sc: "Simple Sub" },
    { topic: "Subtraction", diff: "Easy", q: "5 - 0 = ?", a: "5", w: ["0", "4", "3"], h: "Don't take anything.", sc: "Zero Property" },
    { topic: "Subtraction", diff: "Easy", q: "4 - 2 = ?", a: "2", w: ["1", "3", "4"], h: "Half of four.", sc: "Halves" },
    { topic: "Subtraction", diff: "Easy", q: "3 - 0 = ?", a: "3", w: ["0", "2", "1"], h: "Stays the same.", sc: "Zero Property" },
    { topic: "Subtraction", diff: "Easy", q: "2 - 1 = ?", a: "1", w: ["0", "2", "3"], h: "Two minus one.", sc: "Difference" },
    { topic: "Subtraction", diff: "Easy", q: "5 - 4 = ?", a: "1", w: ["2", "0", "5"], h: "They are neighbors.", sc: "Difference" },
    { topic: "Subtraction", diff: "Easy", q: "1 - 1 = ?", a: "0", w: ["1", "2", "3"], h: "One take away one.", sc: "Zero Result" },

    // ============================
    // ‚ûñ SUBTRACTION (Hard: 0-10)
    // ============================
    { topic: "Subtraction", diff: "Hard", q: "10 - 5 = ?", a: "5", w: ["4", "6", "0"], h: "Five and five make ten.", sc: "Halves" },
    { topic: "Subtraction", diff: "Hard", q: "9 - 2 = ?", a: "7", w: ["6", "8", "5"], h: "Count back two steps.", sc: "Difference" },
    { topic: "Subtraction", diff: "Hard", q: "8 - 4 = ?", a: "4", w: ["3", "5", "2"], h: "Double four is eight.", sc: "Halves" },
    { topic: "Subtraction", diff: "Hard", q: "7 - 3 = ?", a: "4", w: ["3", "5", "6"], h: "Seven fingers, hide three.", sc: "Difference" },
    { topic: "Subtraction", diff: "Hard", q: "6 - 1 = ?", a: "5", w: ["4", "6", "7"], h: "Just one less.", sc: "Simple Sub" },
    { topic: "Subtraction", diff: "Hard", q: "10 - 8 = ?", a: "2", w: ["1", "3", "8"], h: "Ten is two more than eight.", sc: "Difference" },
    { topic: "Subtraction", diff: "Hard", q: "9 - 0 = ?", a: "9", w: ["0", "8", "10"], h: "Take nothing away.", sc: "Zero Property" },
    { topic: "Subtraction", diff: "Hard", q: "8 - 5 = ?", a: "3", w: ["2", "4", "5"], h: "Five plus three is eight.", sc: "Difference" },
    { topic: "Subtraction", diff: "Hard", q: "7 - 7 = ?", a: "0", w: ["7", "1", "14"], h: "Take everything away.", sc: "Zero Result" },
    { topic: "Subtraction", diff: "Hard", q: "6 - 3 = ?", a: "3", w: ["2", "4", "9"], h: "Three and three make six.", sc: "Halves" },

    // ============================
    // üìê GEOMETRY (Easy: Basics)
    // ============================
    { topic: "Geometry", diff: "Easy", q: "I have 3 sides. What am I?", a: "Triangle", w: ["Square", "Circle", "Star"], h: "Like a slice of pizza.", sc: "Shape ID" },
    { topic: "Geometry", diff: "Easy", q: "Which shape has NO corners?", a: "Circle", w: ["Square", "Triangle", "Rectangle"], h: "It is round.", sc: "Shape ID" },
    { topic: "Geometry", diff: "Easy", q: "I have 4 equal sides.", a: "Square", w: ["Triangle", "Circle", "Star"], h: "Like a box.", sc: "Shape ID" },
    { topic: "Geometry", diff: "Easy", q: "How many corners does a Circle have?", a: "0", w: ["1", "4", "3"], h: "It is smooth all around.", sc: "Properties" },
    { topic: "Geometry", diff: "Easy", q: "Which shape looks like a ball?", a: "Circle", w: ["Square", "Triangle", "Cube"], h: "It rolls.", sc: "Real World" },
    { topic: "Geometry", diff: "Easy", q: "How many sides does a Triangle have?", a: "3", w: ["4", "2", "5"], h: "Tri means three.", sc: "Properties" },
    { topic: "Geometry", diff: "Easy", q: "Which shape looks like a door?", a: "Rectangle", w: ["Circle", "Triangle", "Star"], h: "Two long sides, two short.", sc: "Real World" },
    { topic: "Geometry", diff: "Easy", q: "Which shape has pointy corners?", a: "Triangle", w: ["Circle", "Oval", "Sphere"], h: "Watch out, it's sharp!", sc: "Properties" },
    { topic: "Geometry", diff: "Easy", q: "How many corners does a Square have?", a: "4", w: ["3", "5", "0"], h: "One for each corner of a room.", sc: "Properties" },
    { topic: "Geometry", diff: "Easy", q: "Is a Circle round?", a: "Yes", w: ["No", "Maybe", "Sometimes"], h: "It has no straight lines.", sc: "Properties" },

    // ============================
    // üìê GEOMETRY (Hard: Attributes)
    // ============================
    { topic: "Geometry", diff: "Hard", q: "How many corners in 2 Squares?", a: "8", w: ["4", "6", "10"], h: "4 plus 4.", sc: "Counting" },
    { topic: "Geometry", diff: "Hard", q: "I have 4 sides. 2 long, 2 short.", a: "Rectangle", w: ["Square", "Triangle", "Circle"], h: "Stretched out square.", sc: "Attributes" },
    { topic: "Geometry", diff: "Hard", q: "How many sides in a Triangle + Square?", a: "7", w: ["6", "8", "5"], h: "3 plus 4.", sc: "Counting" },
    { topic: "Geometry", diff: "Hard", q: "Which has MORE sides?", a: "Square", w: ["Triangle", "Circle", "They are equal"], h: "4 is bigger than 3.", sc: "Comparison" },
    { topic: "Geometry", diff: "Hard", q: "Which has FEWER corners?", a: "Triangle", w: ["Square", "Rectangle", "Hexagon"], h: "3 is smaller than 4.", sc: "Comparison" },
    { topic: "Geometry", diff: "Hard", q: "Shape with 5 corners?", a: "Pentagon", w: ["Square", "Triangle", "Circle"], h: "Like a house shape.", sc: "Advanced Shapes" },
    { topic: "Geometry", diff: "Hard", q: "How many corners in 1 Square + 1 Circle?", a: "4", w: ["5", "0", "8"], h: "4 plus 0.", sc: "Counting" },
    { topic: "Geometry", diff: "Hard", q: "What shape is a stop sign?", a: "Octagon", w: ["Hexagon", "Pentagon", "Square"], h: "It has 8 sides.", sc: "Real World" },
    { topic: "Geometry", diff: "Hard", q: "Do parallel lines ever touch?", a: "No", w: ["Yes", "Sometimes", "Only on Tuesdays"], h: "Like train tracks.", sc: "Concepts" },
    { topic: "Geometry", diff: "Hard", q: "Which shape has 6 sides?", a: "Hexagon", w: ["Pentagon", "Square", "Triangle"], h: "Hex means six.", sc: "Advanced Shapes" }
];

            let count = 0;
            for(let item of samples) {
                await setDoc(doc(db, "MathTopics", item.topic, "Quizzes", "Auto_" + count + "_" + Date.now()), { 
                    subConcept: item.sc, 
                    difficulty: item.diff, 
                    question: item.q, 
                    imageUrl: item.img || "", // Some have images, some don't
                    answer: item.a, 
                    wrongOptions: item.w, 
                    hint: item.h
                });
                count++;
            }
            alert(`‚úÖ Successfully added ${count} questions! Go to 'Manage Existing' to see them.`);
        };

        window.loadQuestions = async function() {
            const topic = document.getElementById('filter-topic').value; const list = document.getElementById('questions-list'); list.innerHTML = "Loading...";
            const snap = await getDocs(collection(db, "MathTopics", topic, "Quizzes"));
            if (snap.empty) { list.innerHTML = "<p>No questions found for this topic.</p>"; return; }
            let html = "<table style='width:100%'><tr><th>Question</th><th>Diff</th><th>Action</th></tr>";
            snap.forEach(d => { const q = d.data(); const imgBadge = q.imageUrl ? "üñºÔ∏è" : ""; html += `<tr><td><b>${q.question}</b> ${imgBadge}<br><span style='color:#7f8c8d; font-size:11px;'>Ans: ${q.answer}</span></td><td>${q.difficulty === 'Easy' ? 'üü¢' : 'üî¥'}</td><td><button class="del-btn" onclick="deleteQuestion('${topic}', '${d.id}')">üóëÔ∏è</button></td></tr>`; });
            html += "</table>"; list.innerHTML = html;
        };
        window.deleteQuestion = async function(topic, id) { if(confirm("Delete this question?")) { await deleteDoc(doc(db, "MathTopics", topic, "Quizzes", id)); loadQuestions(); } };

        window.loadScores = async function() {
            const table = document.getElementById('score-table'); table.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
            const snap = await getDocs(query(collection(db, "StudentScores"), orderBy(document.getElementById('sort-by').value, "desc")));
            globalScores = [];
            snap.forEach(d => globalScores.push(d.data()));
            table.innerHTML = "";
            if(globalScores.length === 0) { table.innerHTML = "<tr><td colspan='5'>No student data yet.</td></tr>"; return; }
            globalScores.forEach((s, index) => {
                const hasMistakes = s.mistakes && s.mistakes.length > 0;
                const reportBtn = hasMistakes ? `<button class="report-btn" onclick="openReport(${index})">‚ö†Ô∏è View Mistakes</button>` : `<span style="color:#27ae60; font-size:12px;">‚úÖ Perfect!</span>`;
                table.innerHTML += `<tr><td>${s.studentName}</td><td>${s.topic}</td><td>${s.difficulty || '-'}</td><td>${s.score}</td><td>${reportBtn}</td></tr>`;
            });
        };
        
        window.openReport = function(index) {
            const data = globalScores[index];
            const body = document.getElementById('report-body');
            body.innerHTML = "";
            if(data.mistakes && data.mistakes.length > 0) {
                data.mistakes.forEach(m => {
                    body.innerHTML += `<div class="mistake-item"><b>Question:</b> ${m.q}<br><span style="color:#e74c3c">‚ùå Student: ${m.wrong}</span><br><span style="color:#27ae60">‚úÖ Correct: ${m.right}</span></div>`;
                });
            }
            document.getElementById('report-modal').style.display = 'flex';
        };

        window.onload = loadScores;
    </script>
</body>
</html>