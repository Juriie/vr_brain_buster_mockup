<!DOCTYPE html>
<html>
<head>
    <title>Brain Busters Math Admin</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f4f8; display: flex; gap: 20px; }
        .column { flex: 1; }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-left: 5px solid #3498db; padding-left: 15px; margin-bottom: 20px; }
        input, select, textarea { width: 100%; margin: 8px 0; padding: 12px; border: 1px solid #d1d9e6; border-radius: 6px; box-sizing: border-box; }
        button { background: #3498db; color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        button:hover { opacity: 0.9; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
        .top-score { background: rgba(241, 196, 15, 0.15) !important; font-weight: bold; border-left: 4px solid #f1c40f; }
        
        .tab-btn { flex: 1; padding: 10px; cursor: pointer; background: #e0e0e0; border: none; font-weight: bold; }
        .tab-btn.active { background: #3498db; color: white; }
        .tab-container { display: flex; margin-bottom: 15px; border-radius: 6px; overflow: hidden; }
        .del-btn { background: #e74c3c; color: white; padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 12px; width: auto; }
        
        /* üÜï Preview Image Style */
        #preview-box { margin-top: 10px; text-align: center; display: none; padding: 10px; border: 2px dashed #ccc; border-radius: 6px; background: #fafafa; }
        #preview-img { max-width: 100%; max-height: 150px; border-radius: 4px; display: block; margin: 0 auto; }
    </style>
</head>
<body>
    <div class="column">
        <h1>üî¢ Curriculum Manager</h1>
        <div class="card">
            
            <div class="tab-container">
                <button class="tab-btn active" onclick="showTab('add')" id="btn-add">‚ûï Add New</button>
                <button class="tab-btn" onclick="showTab('manage')" id="btn-manage">üìÇ Manage Existing</button>
            </div>

            <div id="view-add">
                <h3>Add Kindergarten Quiz</h3>
                <select id="math-topic">
                    <option value="Addition">Addition ‚ûï</option>
                    <option value="Subtraction">Subtraction ‚ûñ</option>
                    <option value="Geometry">Geometry üìê</option>
                </select>
                <select id="quiz-difficulty">
                    <option value="Easy">Easy (0-5) üü¢</option>
                    <option value="Hard">Hard (0-10) üî¥</option>
                </select>
                <input type="text" id="sub-concept" placeholder="Concept Name (e.g., Adding 1s)">
                <input type="text" id="question" placeholder="Question (e.g., Count the apples)">
                
                <div style="display: flex; gap: 5px; align-items: center;">
                    <input type="text" id="q-image" placeholder="üñºÔ∏è Image URL (Direct .jpg/.png link)" style="margin:0;">
                    <button onclick="testImage()" style="width: auto; padding: 10px; background: #f39c12;">Test Link üñºÔ∏è</button>
                </div>
                <div id="preview-box">
                    <span style="font-size: 12px; color: #777;">Image Preview:</span>
                    <img id="preview-img" src="" onerror="imgError()">
                    <p id="img-msg" style="color: red; font-size: 12px; display: none;">‚ùå Link broken. Try a direct image link.</p>
                </div>
                
                <input type="text" id="answer" placeholder="Correct Answer (e.g. 5)" style="margin-top: 8px;">
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="w1" placeholder="Wrong 1"><input type="text" id="w2" placeholder="Wrong 2"><input type="text" id="w3" placeholder="Wrong 3">
                </div>
                <textarea id="hint" placeholder="üí° Hint..."></textarea>
                <button onclick="addQuiz()" style="background: #27ae60;">Save to Cloud ‚òÅÔ∏è</button>
            </div>

            <div id="view-manage" style="display:none;">
                <h3>Question Bank</h3>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="filter-topic" onchange="loadQuestions()">
                        <option value="Addition">Addition ‚ûï</option>
                        <option value="Subtraction">Subtraction ‚ûñ</option>
                        <option value="Geometry">Geometry üìê</option>
                    </select>
                    <button onclick="loadQuestions()" style="width: auto; padding: 8px 15px; background: #95a5a6;">Refresh üîÑ</button>
                </div>
                <div id="questions-list" style="max-height: 400px; overflow-y: auto;">
                    <p style="color:#777;">Select a topic and click Refresh.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="column">
        <h1>üìä Mastery Tracker</h1>
        <div class="card">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h3>Student Progress</h3>
                <button onclick="loadScores()" style="width: auto; padding: 8px 15px; background: #95a5a6;">Refresh üîÑ</button>
            </div>
            <select id="sort-by" onchange="loadScores()">
                <option value="timestamp">Most Recent ‚è±Ô∏è</option>
                <option value="score">Highest Score üèÜ</option>
            </select>
            <table>
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Topic</th>
                        <th>Level</th>
                        <th>Score</th>
                        <th>Rank</th>
                    </tr>
                </thead>
                <tbody id="score-table"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { doc, setDoc, deleteDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        window.showTab = function(mode) {
            document.getElementById('view-add').style.display = mode === 'add' ? 'block' : 'none';
            document.getElementById('view-manage').style.display = mode === 'manage' ? 'block' : 'none';
            document.getElementById('btn-add').className = mode === 'add' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('btn-manage').className = mode === 'manage' ? 'tab-btn active' : 'tab-btn';
            if(mode === 'manage') loadQuestions();
        };

        // üÜï Image Testing Function
        window.testImage = function() {
            const url = document.getElementById('q-image').value;
            if(!url) return;
            document.getElementById('preview-box').style.display = 'block';
            const img = document.getElementById('preview-img');
            document.getElementById('img-msg').style.display = 'none';
            img.style.display = 'block';
            img.src = url;
        };

        window.imgError = function() {
            document.getElementById('preview-img').style.display = 'none';
            document.getElementById('img-msg').style.display = 'block';
        };

        window.addQuiz = async function() {
            const q = document.getElementById('question').value;
            const a = document.getElementById('answer').value;
            if(!q || !a) { alert("Please fill in the Question and Answer!"); return; }

            const topic = document.getElementById('math-topic').value;
            const sc = document.getElementById('sub-concept').value || "General";
            
            await setDoc(doc(db, "MathTopics", topic, "Quizzes", sc + "_" + Date.now()), { 
                subConcept: sc,
                difficulty: document.getElementById('quiz-difficulty').value,
                question: q,
                imageUrl: document.getElementById('q-image').value.trim(), // üÜï Trim whitespace
                answer: a,
                wrongOptions: [
                    document.getElementById('w1').value.trim(), 
                    document.getElementById('w2').value.trim(), 
                    document.getElementById('w3').value.trim()
                ],
                hint: document.getElementById('hint').value
            });

            // Clear Form
            document.getElementById('question').value = "";
            document.getElementById('q-image').value = "";
            document.getElementById('answer').value = "";
            document.getElementById('w1').value = "";
            document.getElementById('w2').value = "";
            document.getElementById('w3').value = "";
            document.getElementById('hint').value = "";
            document.getElementById('preview-box').style.display = 'none'; // Hide preview
            
            alert("Question Saved! ‚ú®");
        };

        window.loadQuestions = async function() {
            const topic = document.getElementById('filter-topic').value;
            const list = document.getElementById('questions-list');
            list.innerHTML = "Loading...";

            const snap = await getDocs(collection(db, "MathTopics", topic, "Quizzes"));
            
            if (snap.empty) {
                list.innerHTML = "<p>No questions found for this topic.</p>";
                return;
            }

            let html = "<table style='width:100%'>";
            html += "<tr><th>Question</th><th>Diff</th><th>Action</th></tr>";
            
            snap.forEach(d => {
                const q = d.data();
                const imgBadge = q.imageUrl ? "üñºÔ∏è" : "";
                html += `
                    <tr>
                        <td>
                            <b>${q.question}</b> ${imgBadge}<br>
                            <span style='color:#7f8c8d; font-size:11px;'>Ans: ${q.answer}</span>
                        </td>
                        <td>${q.difficulty === 'Easy' ? 'üü¢' : 'üî¥'}</td>
                        <td>
                            <button class="del-btn" onclick="deleteQuestion('${topic}', '${d.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
            html += "</table>";
            list.innerHTML = html;
        };

        window.deleteQuestion = async function(topic, id) {
            if(confirm("Are you sure you want to delete this question?")) {
                await deleteDoc(doc(db, "MathTopics", topic, "Quizzes", id));
                loadQuestions(); 
            }
        };

        window.loadScores = async function() {
            const table = document.getElementById('score-table');
            table.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
            
            const snap = await getDocs(query(collection(db, "StudentScores"), orderBy(document.getElementById('sort-by').value, "desc")));
            
            let scoresData = [];
            snap.forEach(d => scoresData.push(d.data()));
            table.innerHTML = "";
            if(scoresData.length === 0) { table.innerHTML = "<tr><td colspan='5'>No student data yet.</td></tr>"; return; }
            scoresData.forEach(s => {
                table.innerHTML += `<tr><td>${s.studentName}</td><td>${s.topic}</td><td>${s.difficulty || '-'}</td><td>${s.score}</td><td>${s.rank}</td></tr>`;
            });
        };
        window.onload = loadScores;
    </script>
</body>
</html>