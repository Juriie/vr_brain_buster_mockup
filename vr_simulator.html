<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kindergarten Math VR</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; background: #050505; font-family: 'Fredoka', sans-serif; 
            display: flex; align-items: center; justify-content: center; 
            height: 100vh; color: white; overflow: hidden; perspective: 1200px; 
        }

        .viewport { 
            width: 950px; height: 550px; 
            /* Default Background (Space) */
            background: url('https://images.unsplash.com/photo-1635070041078-e363dbe005cb?auto=format&fit=crop&q=80&w=2070') center/cover;
            border-radius: 40px; display: flex; justify-content: center; align-items: center; 
            border: 10px solid #333; position: relative; 
            transition: background 0.5s ease-in-out, transform 0.1s ease-out, box-shadow 0.3s;
            box-shadow: 0 0 80px rgba(0,0,0,0.8) inset;
            overflow: hidden; 
        }

        /* üÜï Combo Glow Effects */
        .viewport.combo-x2 { box-shadow: 0 0 50px rgba(230, 126, 34, 0.6) inset; border-color: #d35400; }
        .viewport.combo-x3 { box-shadow: 0 0 80px rgba(231, 76, 60, 0.9) inset; border-color: #c0392b; animation: pulseRed 1s infinite; }
        
        @keyframes pulseRed { 0% { border-color: #c0392b; } 50% { border-color: #f1c40f; } 100% { border-color: #c0392b; } }

        .hud-panel { 
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2); padding: 40px; border-radius: 30px; width: 550px; text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform-style: preserve-3d; z-index: 10; 
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-height: 480px; overflow-y: auto;
        }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .menu-btn { background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 15px; margin: 10px 0; border-radius: 15px; cursor: pointer; width: 100%; font-size: 18px; font-weight: 600; font-family: 'Fredoka', sans-serif; transition: all 0.3s ease; }
        .menu-btn:hover { background: linear-gradient(135deg, rgba(52, 152, 219, 0.4), rgba(52, 152, 219, 0.2)); transform: translateY(-3px) scale(1.02); }
        
        .quiz-option { background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.1); color: white; padding: 15px; margin: 10px 5px; border-radius: 15px; cursor: pointer; width: 45%; font-size: 22px; font-family: 'Fredoka', sans-serif; transition: all 0.2s; display: inline-block; }
        .quiz-option:hover { background: rgba(255, 255, 255, 0.25); transform: scale(1.05); }
        .q-img { max-width: 250px; max-height: 180px; border-radius: 15px; margin: 15px auto; display: block; border: 4px solid white; box-shadow: 0 8px 25px rgba(0,0,0,0.4); transform: rotate(-2deg); transition: transform 0.3s; }
        .speak-btn { background: rgba(255,255,255,0.2); border-radius: 50%; width: 40px; height: 40px; border: none; font-size: 20px; cursor: pointer; vertical-align: middle; transition: transform 0.2s; display: inline-flex; align-items: center; justify-content: center; margin-left: 10px;}
        .speak-btn:hover { background: #f1c40f; transform: scale(1.1) rotate(10deg); color: #000; }
        
        #timer-display { color: #f1c40f; font-weight: bold; font-family: monospace; font-size: 28px; }
        .progress-bar { width: 100%; height: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 25px; overflow: hidden; }
        #prog-fill { height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); transition: width 0.5s; }
        .error-msg { color: #ff6b6b; background: rgba(255, 107, 107, 0.15); border: 1px solid #ff6b6b; padding: 12px; border-radius: 10px; font-size: 14px; margin-bottom: 15px; display: none; }
        .name-input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; text-align: center; font-size: 20px; font-family: 'Fredoka', sans-serif; }
        
        /* üÜï Combo Badge */
        #combo-badge { 
            position: absolute; top: 20px; right: 20px; 
            font-size: 24px; font-weight: bold; 
            background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 20px;
            border: 2px solid #f39c12; color: #f1c40f;
            display: none; animation: popIn 0.3s;
            z-index: 20;
        }

        .review-card { background: rgba(0, 0, 0, 0.4); border-radius: 12px; padding: 15px; margin: 10px 0; text-align: left; border-left: 5px solid #e74c3c; }
        .star { font-size: 70px; display: inline-block; transition: transform 0.4s; opacity: 0.3; color: #444; filter: grayscale(1); }
        .star.earned { color: #f1c40f; opacity: 1; transform: scale(1.2); filter: grayscale(0) drop-shadow(0 0 15px #f1c40f); }
        #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.5); } }
        .score-popup { position: absolute; font-weight: 800; font-size: 32px; animation: floatUp 0.8s forwards; pointer-events: none; text-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 20; }
    </style>
</head>
<body>
    <div class="viewport" id="game-viewport">
        <div id="combo-badge">üî• Streak: 0</div>
        
        <div id="particles-container"></div>
        <canvas id="confetti-canvas"></canvas>

        <div id="view-menu" class="hud-panel">
            <h1 style="font-size: 48px; margin-bottom: 10px;">üß† Brain Busters VR</h1>
            <p style="color: #bdc3c7;">Ready to learn, explorer?</p>
            <div id="menu-error" class="error-msg"></div>
            <button class="menu-btn" onclick="startMathFlow()">üöÄ Start Mission</button>
            <button class="menu-btn" onclick="switchView('view-leaderboard')">üèÜ Hall of Fame</button>
            <button class="menu-btn" onclick="switchView('view-settings')">‚öôÔ∏è Gear Setup</button>
        </div>

        <div id="view-login" class="hud-panel" style="display:none;">
            <h2>üëã Welcome Aboard!</h2>
            <input type="text" id="intro-name" class="name-input" placeholder="Your Name Here">
            <button class="menu-btn" onclick="submitName()">‚úÖ Lets Go!</button>
            <button class="menu-btn" onclick="switchView('view-menu')">Back</button>
        </div>

        <div id="view-settings" class="hud-panel" style="display:none;">
            <h2>‚öôÔ∏è System Setup</h2>
            <label style="display:block; text-align:left;">Pilot Name:</label>
            <input type="text" id="player-name" class="name-input" placeholder="Name">
            <label style="display:block; text-align:left;">SFX Volume üîä</label>
            <input type="range" id="sfx-vol" min="0" max="100" value="70" onchange="testSfx()" style="width:100%;">
            <label style="display:flex; justify-content:space-between; align-items:center; margin:15px 0;">
                <span>üó£Ô∏è Auto-Read</span> <input type="checkbox" id="auto-read" checked style="transform:scale(1.5);">
            </label>
            <button class="menu-btn" onclick="saveSettings()">üíæ Save Config</button>
        </div>

        <div id="view-topics" class="hud-panel" style="display:none;">
            <h2>üöÄ Select Mission</h2>
            <div style="margin-bottom: 20px;">
                <label>‚ûï Addition (Underwater)</label>
                <div style="display:flex; gap:10px;">
                    <button class="menu-btn" onclick="enterMathRoom('Addition', 'Easy')" style="background:#27ae60;">Easy</button>
                    <button class="menu-btn" onclick="enterMathRoom('Addition', 'Hard')" style="background:#c0392b;">Hard</button>
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <label>‚ûñ Subtraction (Jungle)</label>
                <div style="display:flex; gap:10px;">
                    <button class="menu-btn" onclick="enterMathRoom('Subtraction', 'Easy')" style="background:#27ae60;">Easy</button>
                    <button class="menu-btn" onclick="enterMathRoom('Subtraction', 'Hard')" style="background:#c0392b;">Hard</button>
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <label>üìê Geometry (Space)</label>
                <div style="display:flex; gap:10px;">
                    <button class="menu-btn" onclick="enterMathRoom('Geometry', 'Easy')" style="background:#27ae60;">Easy</button>
                    <button class="menu-btn" onclick="enterMathRoom('Geometry', 'Hard')" style="background:#c0392b;">Hard</button>
                </div>
            </div>
            <button class="menu-btn" onclick="switchView('view-menu')">üè† Base</button>
        </div>

        <div id="view-game" class="hud-panel" style="display:none;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <div id="timer-display">00:00</div>
                <div id="display-score">Score: 0</div>
            </div>
            <div style="display:flex; justify-content:center; align-items:center; gap:10px;">
                <h2 id="display-question" style="margin:0; font-size:32px;">Loading...</h2>
                <button class="speak-btn" onclick="speakCurrentQuestion()">üîä</button>
            </div>
            <div id="img-container"></div>
            <div id="options-container" style="position:relative; margin-top:20px;"></div>
            <div id="hint-display" style="display:none; color:#f1c40f; font-style:italic; margin-top:15px;"></div>
            <div class="progress-bar"><div id="prog-fill" style="width:0%;"></div></div>
            <button class="menu-btn" style="margin-top:25px; background:rgba(231,76,60,0.5);" onclick="switchView('view-topics')">üè≥Ô∏è Abort</button>
        </div>

        <div id="view-summary" class="hud-panel" style="display:none;">
            <h2 id="end-title">Mission Complete! üåü</h2>
            <div id="star-container" style="margin: 20px 0;"><span class="star" id="star1">‚òÖ</span><span class="star" id="star2">‚òÖ</span><span class="star" id="star3">‚òÖ</span></div>
            <h1>Score: <span id="final-score" style="color:#2ecc71;">0</span></h1>
            <p id="rank-display"></p>
            <div id="mistake-review" style="border-top:1px solid #555; padding-top:15px; display:none;">
                <h3 style="color:#f1c40f;">üîç Debrief</h3>
                <div id="mistake-list" style="max-height:150px; overflow-y:auto;"></div>
            </div>
            <button class="menu-btn" onclick="switchView('view-menu')">üè† Return</button>
        </div>

        <div id="view-leaderboard" class="hud-panel" style="display:none;">
            <h2>üèÜ Hall of Fame</h2>
            <div id="leaderboard-list" style="max-height:350px; overflow-y:auto; text-align:left; padding:15px;">Loading...</div>
            <button class="menu-btn" onclick="switchView('view-menu')">üè† Back</button>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, getDocs, query, where, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // AUDIO & SPEECH
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration, volFactor) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const sliderVal = document.getElementById('sfx-vol').value; const volume = (sliderVal / 100) * volFactor; if (volume <= 0) return;
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(volume, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gainNode); gainNode.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration);
        }
        window.sfx = { 
            click: () => playTone(600, 'sine', 0.1, 0.3), 
            correct: () => { playTone(600, 'sine', 0.1, 0.5); setTimeout(() => playTone(1200, 'sine', 0.3, 0.5), 100); }, 
            wrong: () => { playTone(150, 'sawtooth', 0.4, 0.4); setTimeout(() => playTone(100, 'sawtooth', 0.4, 0.4), 200); }, 
            win: () => { playTone(400, 'square', 0.2, 0.3); setTimeout(() => playTone(500, 'square', 0.2, 0.3), 200); setTimeout(() => playTone(600, 'square', 0.4, 0.3), 400); },
            // üÜï New Sound for Combo Loss
            fizz: () => { playTone(100, 'sawtooth', 0.5, 0.5); }
        };
        window.testSfx = function() { window.sfx.correct(); };

        const synth = window.speechSynthesis; let voices = []; function loadVoices() { voices = synth.getVoices(); } loadVoices(); if (speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = loadVoices; }
        window.speak = function(text) { if (synth.speaking) synth.cancel(); const utter = new SpeechSynthesisUtterance(text); const friendlyVoice = voices.find(v => v.name.includes("Google US English") || v.name.includes("Samantha")); if (friendlyVoice) utter.voice = friendlyVoice; utter.rate = 0.9; utter.pitch = 1.1; synth.speak(utter); };
        window.speakCurrentQuestion = function() { const txt = document.getElementById('display-question').innerText; if(txt && txt !== "Loading...") window.speak(txt); };

        const canvas = document.getElementById('confetti-canvas'); const ctx = canvas.getContext('2d'); canvas.width = 950; canvas.height = 550; let particles = [];
        function startConfetti() { particles = []; for(let i=0; i<120; i++) { particles.push({ x: canvas.width/2, y: canvas.height/2, vx: (Math.random()-0.5)*20, vy: (Math.random()-1)*20, color: `hsl(${Math.random()*360}, 100%, 60%)`, size: Math.random()*8+5, life: 100 }); } updateConfetti(); }
        function updateConfetti() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life--; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill(); if(p.life <= 0) particles.splice(i, 1); }); if(particles.length > 0) requestAnimationFrame(updateConfetti); }
        document.addEventListener('mousemove', (e) => { const viewport = document.getElementById('game-viewport'); const x = (window.innerWidth/2 - e.pageX)/40; const y = (window.innerHeight/2 - e.pageY)/40; viewport.style.transform = `rotateY(${x}deg) rotateX(${y}deg)`; });

        let subConcepts = [], currentIdx = 0, score = 0, seconds = 0, timer, currentTopic = "", currentDifficulty = "", qStartTime = 0; let mistakeLog = [];
        // üÜï COMBO VARS
        let streak = 0; let multiplier = 1;

        function clearErrors() { document.querySelectorAll('.error-msg').forEach(el => { el.style.display = 'none'; el.innerText = ''; }); }
        function showError(elementId, msg) { const el = document.getElementById(elementId); el.innerText = "‚ö†Ô∏è " + msg; el.style.display = 'block'; }
        function showScorePopup(amount, color, element) { const popup = document.createElement("div"); popup.className = "score-popup"; popup.innerText = amount; popup.style.color = color; popup.style.left = "50%"; popup.style.top = "-20px"; element.appendChild(popup); setTimeout(() => popup.remove(), 1000); }
        document.addEventListener('click', (e) => { if(e.target.tagName === 'BUTTON' && !e.target.disabled && !e.target.classList.contains('speak-btn')) window.sfx.click(); });

        window.switchView = function(id) { 
            clearErrors(); document.querySelectorAll('.hud-panel').forEach(p => { if(p.style.display !== 'none') { p.style.display = 'none'; } });
            const target = document.getElementById(id); target.style.display = 'block';
            if(id === 'view-leaderboard') loadLeaderboard();
            if(id === 'view-menu') { 
                // Reset to default space bg on menu
                document.querySelector('.viewport').style.backgroundImage = "url('https://images.unsplash.com/photo-1635070041078-e363dbe005cb?auto=format&fit=crop&q=80&w=2070')";
                document.querySelector('.viewport').className = "viewport"; // Remove combo effects
            }
        };
        window.startMathFlow = function() { const currentName = document.getElementById('player-name').value; if (currentName.trim() === "") { switchView('view-login'); } else { switchView('view-topics'); } };
        window.submitName = function() { const name = document.getElementById('intro-name').value; if (name.trim() === "") { showError('login-error', "Please enter a name!"); return; } document.getElementById('player-name').value = name; switchView('view-topics'); };
        window.saveSettings = function() { const name = document.getElementById('player-name').value; document.getElementById('intro-name').value = name; switchView('view-menu'); }

        window.enterMathRoom = async function(topic, level) {
            const name = document.getElementById('player-name').value; if(!name) { switchView('view-login'); return; }
            currentTopic = topic; currentDifficulty = level; currentIdx = 0; score = 0; seconds = 0; mistakeLog = [];
            streak = 0; multiplier = 1; // üÜï Reset Combo
            updateComboUI();

            // üÜï DYNAMIC WORLDS
            const vp = document.querySelector('.viewport');
            if (topic === 'Addition') vp.style.backgroundImage = "url('https://images.unsplash.com/photo-1551244072-5d12893278ab?auto=format&fit=crop&q=80&w=2000')"; // Underwater
            else if (topic === 'Subtraction') vp.style.backgroundImage = "url('https://images.unsplash.com/photo-1564466988855-68098c4f0923?auto=format&fit=crop&q=80&w=2000')"; // Jungle
            else vp.style.backgroundImage = "url('https://images.unsplash.com/photo-1635070041078-e363dbe005cb?auto=format&fit=crop&q=80&w=2070')"; // Space (Default)

            document.getElementById('display-score').innerText = "Score: 0"; document.getElementById('timer-display').innerText = "00:00"; document.getElementById('prog-fill').style.width = "0%"; document.getElementById('display-question').innerText = "Loading..."; document.getElementById('img-container').innerHTML = ""; document.getElementById('options-container').innerHTML = "";
            switchView('view-game');
            try { const q = query(collection(db, "MathTopics", topic, "Quizzes"), where("difficulty", "==", level)); const snap = await getDocs(q); subConcepts = snap.docs.map(d => d.data()); if (subConcepts.length > 0) { startTimer(); showQuestion(); } else { alert(`No ${level} questions found!`); switchView('view-topics'); } } catch (e) { alert("Error connecting to database."); switchView('view-menu'); }
        };

        function startTimer() { clearInterval(timer); timer = setInterval(() => { seconds++; let m = Math.floor(seconds/60).toString().padStart(2,'0'); let s = (seconds%60).toString().padStart(2,'0'); document.getElementById('timer-display').innerText = `${m}:${s}`; }, 1000); }

        function showQuestion() {
            qStartTime = seconds; const sc = subConcepts[currentIdx]; document.getElementById('display-question').innerText = sc.question;
            if(document.getElementById('auto-read').checked) setTimeout(() => window.speak(sc.question), 600);
            const imgBox = document.getElementById('img-container'); imgBox.innerHTML = "";
            if (sc.imageUrl && sc.imageUrl.trim() !== "") { const img = document.createElement("img"); img.src = sc.imageUrl; img.className = "q-img"; img.onerror = function() { this.style.display = 'none'; }; imgBox.appendChild(img); }
            document.getElementById('prog-fill').style.width = (currentIdx / subConcepts.length * 100) + "%"; document.getElementById('hint-display').style.display = "none";
            const container = document.getElementById('options-container'); container.innerHTML = "";
            let validWrongs = (sc.wrongOptions || []).filter(opt => opt && opt.trim() !== ""); let choices = [sc.answer, ...validWrongs].sort(() => Math.random() - 0.5);
            choices.forEach(c => { const b = document.createElement('button'); b.className = "quiz-option"; b.innerText = c; b.onclick = () => check(c, sc.answer, b, sc.question); container.appendChild(b); });
        }

        // üÜï COMBO HELPER
        function updateComboUI() {
            const badge = document.getElementById('combo-badge');
            const vp = document.querySelector('.viewport');
            
            if (streak >= 3) {
                badge.style.display = 'block';
                badge.innerText = streak >= 5 ? `üî•üî• MAX STREAK (x3)!` : `üî• Streak: ${streak} (x2)`;
                if(streak >= 5) vp.className = "viewport combo-x3";
                else vp.className = "viewport combo-x2";
            } else {
                badge.style.display = 'none';
                vp.className = "viewport"; // Reset glow
            }
        }

        async function check(sel, cor, btn, questionText) {
            const allBtns = document.querySelectorAll('.quiz-option');
            
            if (sel === cor) {
                window.sfx.correct(); 
                if(document.getElementById('auto-read').checked) window.speak(["Great job!", "Awesome!", "Correct!"][Math.floor(Math.random()*3)]);
                
                // üÜï Update Streak
                streak++;
                if (streak >= 5) multiplier = 3;
                else if (streak >= 3) multiplier = 2;
                else multiplier = 1;
                updateComboUI();

                allBtns.forEach(b => b.disabled = true); 
                btn.style.background = "linear-gradient(135deg, #27ae60, #2ecc71)"; btn.style.borderColor = "#2ecc71";
                
                const timeTaken = seconds - qStartTime; 
                let basePoints = 10;
                if (timeTaken <= 5) basePoints = 20; else if (timeTaken <= 15) basePoints = 15;
                
                let finalPoints = basePoints * multiplier;
                let msg = `+${finalPoints}` + (multiplier > 1 ? ` (x${multiplier})` : "");
                
                score += finalPoints; 
                showScorePopup(msg, "#2ecc71", btn); 
                document.getElementById('display-score').innerText = "Score: " + score;
                setTimeout(async () => { currentIdx++; if (currentIdx < subConcepts.length) showQuestion(); else await finishGame(); }, 1200);
            
            } else {
                window.sfx.wrong(); 
                // üÜï Combo Breaker
                if (streak >= 3) window.sfx.fizz(); // Play fizz sound if losing a streak
                streak = 0; multiplier = 1; updateComboUI();

                btn.style.background = "linear-gradient(135deg, #c0392b, #e74c3c)"; btn.style.borderColor = "#e74c3c";
                document.getElementById('hint-display').innerText = "üí° Try again!"; document.getElementById('hint-display').style.display = "block";
                mistakeLog.push({ q: questionText, wrong: sel, right: cor });
                if(score > 0) { score -= 5; if(score < 0) score = 0; showScorePopup("-5", "#e74c3c", btn); document.getElementById('display-score').innerText = "Score: " + score; }
                btn.disabled = true; 
            }
        }

        async function finishGame() {
            clearInterval(timer);
            // ... (rest of finishGame remains same)
            let maxPossible = subConcepts.length * 60; // Approx max with combo
            let stars = 1; let rank = "C (Explorer)";
            // Adjusted logic for higher combo scores
            if (score >= subConcepts.length * 20) { stars = 3; rank = "A (Galactic Master!)"; } 
            else if (score >= subConcepts.length * 10) { stars = 2; rank = "B (Star Pilot!)"; }
            
            document.querySelectorAll('.star').forEach(s => s.classList.remove('earned'));
            setTimeout(() => { if(stars>=1) document.getElementById('star1').classList.add('earned'); }, 300);
            setTimeout(() => { if(stars>=2) document.getElementById('star2').classList.add('earned'); }, 600);
            setTimeout(() => { if(stars>=3) document.getElementById('star3').classList.add('earned'); }, 900);
            document.getElementById('end-title').innerText = stars === 3 ? "Galactic Master! üåü" : "Good Mission! üöÄ";
            document.getElementById('final-score').innerText = score; document.getElementById('rank-display').innerText = "Rank: " + rank;

            const reviewBox = document.getElementById('mistake-review'); const reviewList = document.getElementById('mistake-list'); reviewList.innerHTML = "";
            if (mistakeLog.length > 0) { reviewBox.style.display = "block"; mistakeLog.forEach(m => { reviewList.innerHTML += `<div class="review-card"><div class="review-q">‚ùì ${m.q}</div><div class="review-ans"><span style="color:#e74c3c">‚ùå ${m.wrong}</span> | <span style="color:#2ecc71">‚úÖ ${m.right}</span></div></div>`; }); } else { reviewBox.style.display = "none"; }

            if(document.getElementById('auto-read').checked) window.speak(stars === 3 ? "Wow! You are a galactic master!" : "Good mission! You finished!");
            if(stars === 3) { window.sfx.win(); startConfetti(); } else { window.sfx.correct(); }

            await addDoc(collection(db, "StudentScores"), { studentName: document.getElementById('player-name').value, topic: currentTopic, difficulty: currentDifficulty, score: score, rank: rank, mistakes: mistakeLog, timestamp: new Date() });
            switchView('view-summary');
        }

        async function loadLeaderboard() {
            const list = document.getElementById('leaderboard-list'); list.innerHTML = "Loading...";
            try { const snap = await getDocs(query(collection(db, "StudentScores"), orderBy("score", "desc"))); list.innerHTML = ""; if(snap.empty) { list.innerHTML = "No scores yet. Be the first!"; return; } snap.forEach(d => { const s = d.data(); list.innerHTML += `<div style="border-bottom:1px solid rgba(255,255,255,0.1); padding:10px; font-size:18px;">‚≠ê <b>${s.studentName}</b>: ${s.score} <span style="font-size:12px; opacity:0.7">(${s.topic})</span></div>`; }); } catch(e) { list.innerHTML = "Error loading scores."; }
        }
    </script>
</body>
</html>